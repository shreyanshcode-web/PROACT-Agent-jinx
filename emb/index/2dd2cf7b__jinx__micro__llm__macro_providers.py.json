{"file_rel": "jinx\\micro\\llm\\macro_providers.py", "file_sha256": "75f449031dd2951d7534d236dbd8cd903e79ef8747a9a614dc766ef46fff6184", "updated_ts": 1760763312.271388, "total_chunks": 14, "chunks": [{"sha": "593dd2a79bd9e501f755a7e6086b15244eba674390423bf17b471d6b71e3c216", "index": 0, "path": "2dd2cf7b__jinx__micro__llm__macro_providers.py\\593dd2a79bd9e501f755a7e6086b15244eba674390423bf17b471d6b71e3c216.json", "terms": ["jinx", "micro", "memory", "from", "import", "str", "embeddings", "llm", "__future__", "_dlg_topk", "_memroute", "_norm_preview", "_parse_turns", "_pins_load", "_pins_save", "_proj_topk", "_query_graph", "_rank_memory", "_read_channel", "_read_compact", "_read_evergreen", "_read_topic", "_registered", "_run_status", "_run_stderr"], "text_preview": "from __future__ import annotations\n\nimport os\nimport re\nfrom typing import List\n\nfrom jinx.micro.llm.macro_registry import register_macro, MacroContext\nfrom jinx.micro.embeddings.retrieval import retrieve_top_k as _dlg_topk\nfrom jinx.micro.embeddings.proje", "line_start": 1, "line_end": 23}, {"sha": "7c51191ef8804fdcd1ac7a9a9ef4bd9ae3fb1b61a0899eb0b40890398c7e633f", "index": 1, "path": "2dd2cf7b__jinx__micro__llm__macro_providers.py\\7c51191ef8804fdcd1ac7a9a9ef4bd9ae3fb1b61a0899eb0b40890398c7e633f.json", "terms": ["args", "except", "exception", "try", "int", "strip", "str", "ctx", "getenv", "lim", "max", "not", "scope", "dialogue", "else", "list", "return", "_emb_handler", "input_text", "jinx_macro_emb_ms", "jinx_macro_emb_preview_chars", "jinx_macro_emb_topk", "anchor", "anchors", "async"], "text_preview": "return s[:lim]\n\n\nasync def _emb_handler(args: List[str], ctx: MacroContext) -> str:\n    try:\n        scope = (args[0] if args else \"dialogue\").strip().lower()\n    except Exception:\n        scope = \"dialogue\"\n    n = 0\n    q = \"\"\n    # parse args like [scop", "line_start": 24, "line_end": 68}, {"sha": "14bb20808414507ed3f89cff3e6f00f1dfe462b8a5a5fae887bcacf951963ea5", "index": 2, "path": "2dd2cf7b__jinx__micro__llm__macro_providers.py\\14bb20808414507ed3f89cff3e6f00f1dfe462b8a5a5fae887bcacf951963ea5.json", "terms": ["meta", "out", "get", "file_rel", "append", "for", "hits", "obj", "_norm_preview", "_score", "max_time_ms", "text_preview", "str", "await", "continue", "else", "int", "lim", "return", "scope", "strip", "_dlg_topk", "_memfacts_handler", "_proj_topk", "_src"], "text_preview": "if scope in (\"dialogue\", \"dlg\"):\n        hits = await _dlg_topk(q, k=n, max_time_ms=ms)\n        for _score, _src, obj in hits:\n            meta = obj.get(\"meta\", {})\n            pv = (meta.get(\"text_preview\") or \"\").strip()\n            if not pv:\n         ", "line_start": 69, "line_end": 100}, {"sha": "79a5b6ff6b8edfb4dfe9d978e32869129279d8d1f0ede4fdf8c91cc1b82ecddc", "index": 3, "path": "2dd2cf7b__jinx__micro__llm__macro_providers.py\\79a5b6ff6b8edfb4dfe9d978e32869129279d8d1f0ede4fdf8c91cc1b82ecddc.json", "terms": ["args", "kind", "except", "exception", "try", "txt", "strip", "int", "lim", "lines", "return", "str", "decisions", "default", "for", "getenv", "max", "neighbors", "not", "number", "out", "paths", "prefs", "symbols", "term"], "text_preview": "\"\"\"Facts provider: {{m:memfacts:kind[:N]}}\n\n    kind: paths|symbols|prefs|decisions\n    N: number of lines (default 8)\n    \"\"\"\n    kind = (args[0] if args else \"\").strip().lower()\n    if kind not in (\"paths\",\"symbols\",\"prefs\",\"decisions\"):\n        return \"", "line_start": 101, "line_end": 140}, {"sha": "86205febfd7637971c15efed21ac8fa98465e64f0336b4a51a94b64599603ff1", "index": 4, "path": "2dd2cf7b__jinx__micro__llm__macro_providers.py\\86205febfd7637971c15efed21ac8fa98465e64f0336b4a51a94b64599603ff1.json", "terms": ["args", "try", "except", "exception", "term", "int", "items", "name", "not", "return", "strip", "input_text", "jinx_macro_mem_topk", "str", "ctx", "else", "getenv", "len", "max", "memory", "_memtopic_handler", "_query_graph", "already", "async", "await"], "text_preview": "term = (args[0] if args else \"\").strip()\n    if not term:\n        # fallback to input_text\n        term = (ctx.input_text or \"\").strip()\n    n = 0\n    if len(args) > 1:\n        try:\n            n = int(args[1])\n        except Exception:\n            n = 0\n ", "line_start": 141, "line_end": 187}, {"sha": "7647d523eb7f4dfdc026903d4dddc8bc3b036be2f4dc1c944b23dd6952e664df", "index": 5, "path": "2dd2cf7b__jinx__micro__llm__macro_providers.py\\7647d523eb7f4dfdc026903d4dddc8bc3b036be2f4dc1c944b23dd6952e664df.json", "terms": ["except", "exception", "lim", "try", "strip", "int", "txt", "jinx_macro_mem_preview_chars", "args", "ctx", "getenv", "max", "str", "for", "lines", "not", "return", "_memroute_handler", "_read_topic", "input_text", "jinx_macro_mem_topk", "anchors", "assemble", "async", "await"], "text_preview": "lim = max(24, int(os.getenv(\"JINX_MACRO_MEM_PREVIEW_CHARS\", \"160\")))\n    except Exception:\n        lim = 160\n    try:\n        txt = await _read_topic(name)\n    except Exception:\n        txt = \"\"\n    if not txt:\n        return \"\"\n    lines = [ln.strip() for", "line_start": 188, "line_end": 226}, {"sha": "6383e2caa0486f5654dc7075cf7ea1f644e179f159484e82cf6f795dffe10dd5", "index": 6, "path": "2dd2cf7b__jinx__micro__llm__macro_providers.py\\6383e2caa0486f5654dc7075cf7ea1f644e179f159484e82cf6f795dffe10dd5.json", "terms": ["args", "user", "except", "exception", "kind", "try", "ttl_ms", "str", "chars", "clamp", "lim", "lines", "_call", "turns", "async", "await", "def", "else", "int", "key", "return", "strip", "_memroute", "_turns_handler", "jinx_macro_mem_preview_chars"], "text_preview": "# TTL memoization to avoid recomputation within a short window\n    try:\n        ttl_ms = int(os.getenv(\"JINX_MACRO_PROVIDER_TTL_MS\", \"1500\"))\n    except Exception:\n        ttl_ms = 1500\n    key = f\"memroute|{n}|{lim}|{q}\"\n    async def _call() -> str:\n    ", "line_start": 227, "line_end": 263}, {"sha": "47d5e6e1afad67594f08902d3fe4fed39887c1ea7f0f0c9c429e576356a6b7c2", "index": 7, "path": "2dd2cf7b__jinx__micro__llm__macro_providers.py\\47d5e6e1afad67594f08902d3fe4fed39887c1ea7f0f0c9c429e576356a6b7c2.json", "terms": ["lim", "return", "kind", "stdout", "await", "except", "exception", "int", "strip", "try", "turns", "user", "getenv", "run", "str", "clamp", "default", "get", "jinx", "max", "out", "pass", "stderr", "_parse_turns", "_run_handler"], "text_preview": "continue\n        try:\n            n = int(aa)\n        except Exception:\n            pass\n    if n <= 0:\n        return \"\"\n    try:\n        lim = int(os.getenv(\"JINX_MACRO_TURNS_PREVIEW_CHARS\", os.getenv(\"JINX_MACRO_MEM_PREVIEW_CHARS\", \"160\")))\n        lim ", "line_start": 264, "line_end": 303}, {"sha": "b605d6fb4e9aa6c511553f361da34a448ac62b06bc9794c7de6e89d21a76660b", "index": 8, "path": "2dd2cf7b__jinx__micro__llm__macro_providers.py\\b605d6fb4e9aa6c511553f361da34a448ac62b06bc9794c7de6e89d21a76660b.json", "terms": ["ttl_ms", "args", "int", "try", "except", "exception", "lim", "none", "continue", "else", "pass", "jinx_macro_mem_preview_chars", "jinx_run_export_ttl_ms", "chars", "default", "getenv", "kind", "split", "startswith", "stdout", "strip", "ttl", "and", "clamp", "for"], "text_preview": "ttl: freshness window in ms (default JINX_RUN_EXPORT_TTL_MS or 120000)\n    chars: preview clamp (default JINX_MACRO_MEM_PREVIEW_CHARS or 160)\n    \"\"\"\n    kind = (args[0] if args else \"stdout\").strip().lower()\n    n = 0\n    ttl_ms = None\n    lim = None\n    ", "line_start": 304, "line_end": 341}, {"sha": "9abe0dd40a62705c805abaff6b55c3566970fdcf3dcdf4f8c105188ff4cfe5ec", "index": 9, "path": "2dd2cf7b__jinx__micro__llm__macro_providers.py\\9abe0dd40a62705c805abaff6b55c3566970fdcf3dcdf4f8c105188ff4cfe5ec.json", "terms": ["return", "except", "exception", "try", "ttl_ms", "str", "kind", "lim", "args", "def", "getenv", "int", "pttl", "_call", "async", "key", "list", "pins", "_pins_enabled", "_pins_handler", "_pins_load", "_run_status", "_run_stderr", "_run_stdout", "jinx_macro_mem_topk"], "text_preview": "except Exception:\n            lim = 160\n    # TTL memoization across identical macro invocations\n    try:\n        pttl = int(os.getenv(\"JINX_MACRO_PROVIDER_TTL_MS\", \"1500\"))\n    except Exception:\n        pttl = 1500\n    key = f\"run|{kind}|{n}|{ttl_ms}|{lim", "line_start": 342, "line_end": 382}, {"sha": "00d96e90e909d5756d8be2c4542ae719ec7b85a62f9ae5a6033eba70661290a4", "index": 10, "path": "2dd2cf7b__jinx__micro__llm__macro_providers.py\\00d96e90e909d5756d8be2c4542ae719ec7b85a62f9ae5a6033eba70661290a4.json", "terms": ["line", "pins", "str", "return", "not", "except", "exception", "args", "list", "try", "ctx", "def", "join", "out", "strip", "_pins_enabled", "_pins_load", "_pins_save", "input_text", "async", "for", "macrocontext", "pass", "pinned", "_pinadd_handler"], "text_preview": "except Exception:\n        pins = []\n    out = [p for p in pins[:n] if p]\n    return \" | \".join(out)\n\n\nasync def _pinadd_handler(args: List[str], ctx: MacroContext) -> str:\n    \"\"\"Add a pinned line: {{m:pinadd:line...}} (uses input_text if empty).\"\"\"\n    if", "line_start": 383, "line_end": 431}, {"sha": "28ce546326850cd7b713007b7ce60fb585699b4e4c1d2adb0cd46d25530f72e7", "index": 11, "path": "2dd2cf7b__jinx__micro__llm__macro_providers.py\\28ce546326850cd7b713007b7ce60fb585699b4e4c1d2adb0cd46d25530f72e7.json", "terms": ["args", "try", "except", "exception", "compact", "int", "scope", "strip", "jinx_macro_mem_topk", "str", "comp", "default", "else", "for", "getenv", "len", "lim", "lower", "max", "memory", "out", "_mem_handler", "_read_compact", "jinx_macro_mem_preview_chars", "and"], "text_preview": "for m in re.finditer(r\"(?u)[\\w\\.]+\", s or \"\"):\n        t = (m.group(0) or \"\").strip().lower()\n        if t and len(t) >= 3:\n            out.append(t)\n    return out\n\n\nasync def _mem_handler(args: List[str], ctx: MacroContext) -> str:\n    \"\"\"Memory provider", "line_start": 432, "line_end": 473}, {"sha": "b42765cf640efba1f8412336c21fe96db1b3c898303e723ff90740f25f305bc4", "index": 12, "path": "2dd2cf7b__jinx__micro__llm__macro_providers.py\\b42765cf640efba1f8412336c21fe96db1b3c898303e723ff90740f25f305bc4.json", "terms": ["scope", "for", "e_lines", "pool", "c_lines", "compact", "else", "evergreen", "out", "_lines_of", "str", "any", "ever", "lim", "tail_c", "tail_e", "strip", "await", "elif", "extend", "list", "merged", "ranked", "return", "txt"], "text_preview": "ever = await _read_evergreen()\n    except Exception:\n        ever = \"\"\n\n    def _lines_of(txt: str) -> List[str]:\n        return [ln.strip() for ln in (txt or \"\").splitlines() if ln.strip()]\n\n    c_lines = _lines_of(comp)\n    e_lines = _lines_of(ever)\n    ", "line_start": 474, "line_end": 511}, {"sha": "1b211148fbb85cd5a77144f6b78bd9b97af1261986af28598bf79ac102d6d044", "index": 13, "path": "2dd2cf7b__jinx__micro__llm__macro_providers.py\\1b211148fbb85cd5a77144f6b78bd9b97af1261986af28598bf79ac102d6d044.json", "terms": ["register_macro", "await", "out", "_registered", "for", "return", "_emb_handler", "_mem_handler", "_memfacts_handler", "_memgraph_handler", "_memroute_handler", "_memtopic_handler", "_pinadd_handler", "_pindel_handler", "_pins_handler", "_run_handler", "_turns_handler", "c_lines", "register_builtin_macros", "append", "async", "def", "emb", "global", "join"], "text_preview": "for ln in c_lines[-n:]:\n                out.append(ln[:lim])\n\n    out = [s for s in out if s]\n    return \" | \".join(out[:n])\n\n\nasync def register_builtin_macros() -> None:\n    global _registered\n    if _registered:\n        return\n    await register_macro(\"", "line_start": 512, "line_end": 534}], "file_terms": ["args", "except", "exception", "try", "lim", "return", "str", "int", "strip", "out", "await", "for", "not", "getenv", "kind", "def", "else", "list", "ctx", "pins", "max", "line", "scope", "async", "from"]}