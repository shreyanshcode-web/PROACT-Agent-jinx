{"file_rel": "jinx\\micro\\llm\\llm_cache.py", "file_sha256": "ad8279dac66946bd94b4f35a9a176acfcac7a9a0f2ff619bac11eaa02a9e7323", "updated_ts": 1760763312.1983044, "total_chunks": 10, "chunks": [{"sha": "31e94444991d8cac9982c2c06ced9ec0d22197ddbe5bf1fceff23d6d75ef4ae7", "index": 0, "path": "999ae3ed__jinx__micro__llm__llm_cache.py\\31e94444991d8cac9982c2c06ced9ec0d22197ddbe5bf1fceff23d6d75ef4ae7.json", "terms": ["import", "str", "from", "asyncio", "dict", "getenv", "_tlock", "_max_conc", "time", "except", "exception", "float", "try", "_timeout_ms", "_ttl_sec", "api", "default", "future", "int", "jinx", "tuple", "20s", "__future__", "_dump", "_family_inflight"], "text_preview": "from __future__ import annotations\n\nimport asyncio\nimport hashlib\nimport json\nimport os\nimport time\nfrom typing import Any, Dict, Optional, Tuple, List\nfrom threading import Lock as _TLock\n\nfrom jinx.net import get_openai_client\nfrom jinx.micro.parser.api ", "line_start": 1, "line_end": 42}, {"sha": "c6ccd6cb8b595a8205a0fdfd872641d4c91cbbce36fc71310761b5d702f3803b", "index": 1, "path": "999ae3ed__jinx__micro__llm__llm_cache.py\\c6ccd6cb8b595a8205a0fdfd872641d4c91cbbce36fc71310761b5d702f3803b.json", "terms": ["obj", "str", "return", "depth", "for", "type", "_safe_jsonable", "any", "isinstance", "__name__", "json", "def", "dict", "except", "exception", "instructions", "int", "key", "model", "repr", "try", "_fingerprint", "extra_kwargs", "input_text", "and"], "text_preview": "def _safe_jsonable(obj: Any, depth: int = 0) -> Any:\n    \"\"\"Best-effort transform to jsonable structure without exploding on exotic types.\n\n    Limits depth to avoid huge payloads; falls back to repr for unknowns.\n    \"\"\"\n    if depth > 4:\n        return f", "line_start": 43, "line_end": 72}, {"sha": "e66ebdfccd21315a4b04393bc74b5b0a45ce02405e41a086443906f4aaf661ea", "index": 2, "path": "999ae3ed__jinx__micro__llm__llm_cache.py\\e66ebdfccd21315a4b04393bc74b5b0a45ce02405e41a086443906f4aaf661ea.json", "terms": ["str", "input_text", "def", "instructions", "model", "return", "_append", "blue_whispers", "extra_kwargs", "api", "async", "exception", "for", "from", "import", "jinx", "line", "none", "the", "_dump", "_dump_line", "_fingerprint", "_fingerprint_family", "_safe_jsonable", "append_line"], "text_preview": "\"t\": (input_text or \"\"),\n        \"k\": _safe_jsonable(extra_kwargs or {}),\n    }\n    s = json.dumps(payload, ensure_ascii=False, sort_keys=True)\n    return hashlib.sha256(s.encode(\"utf-8\", errors=\"ignore\")).hexdigest()\n\n\ndef _fingerprint_family(instructions", "line_start": 73, "line_end": 104}, {"sha": "0db5414f429e1b0b32eadf8b18133643a7156fea16f541ca51c7ab520f061e3f", "index": 3, "path": "999ae3ed__jinx__micro__llm__llm_cache.py\\0db5414f429e1b0b32eadf8b18133643a7156fea16f541ca51c7ab520f061e3f.json", "terms": ["none", "key", "not", "get", "existing_exact", "existing_fam", "to_wait", "inflight", "item", "_mem", "ek_fpr", "fam_key", "input_text", "no_family", "str", "asyncio", "else", "exp", "for", "instructions", "model", "val", "with", "__no_family__", "_family_inflight"], "text_preview": "ek = extra_kwargs or {}\n    # Strip internal control keys from fingerprinting and outbound SDK kwargs\n    ek_fpr = {str(k): v for k, v in ek.items() if not str(k).startswith(\"__\")}\n    key = _fingerprint(instructions, model, input_text, ek_fpr)\n    fam_key", "line_start": 105, "line_end": 134}, {"sha": "ba33b645061c30e70c0d2f4aaf2c31416e4db4c5cb2fe3de19f568c6f590bfe1", "index": 4, "path": "999ae3ed__jinx__micro__llm__llm_cache.py\\ba33b645061c30e70c0d2f4aaf2c31416e4db4c5cb2fe3de19f568c6f590bfe1.json", "terms": ["asyncio", "model", "task", "fut", "to_wait", "instructions", "key", "str", "none", "not", "_worker", "ek_api", "input_text", "len", "await", "client", "def", "res", "return", "try", "_dump_line", "_family_inflight", "_inflight", "_on_done", "_sem"], "text_preview": "if to_wait is None:\n                fut = loop.create_future()\n                _inflight[key] = fut\n                if not no_family:\n                    _family_inflight[fam_key] = fut\n    if to_wait is not None:\n        try:\n            res = await to_wa", "line_start": 135, "line_end": 164}, {"sha": "7753ac9970a36ee721425c5334bbda2bcbecf51be955cb3b3e8ff4fc7761cb45", "index": 5, "path": "999ae3ed__jinx__micro__llm__llm_cache.py\\7753ac9970a36ee721425c5334bbda2bcbecf51be955cb3b3e8ff4fc7761cb45.json", "terms": ["fut", "except", "not", "done", "out", "pass", "try", "_family_inflight", "fam_key", "set_exception", "baseexception", "exception", "key", "none", "pop", "_inflight", "_mem", "_now", "_on_done", "_ttl_sec", "add_done_callback", "no_family", "output_text", "set_result", "asyncio"], "text_preview": "# Propagate cancellation to awaiters without leaking to event loop logs\n                    if not fut.done():\n                        fut.set_exception(asyncio.CancelledError())\n                    return\n                r = t.result()\n                out", "line_start": 165, "line_end": 193}, {"sha": "11f2243296adaa6ea562c4fcd16c31c30d086380cf08cf959fb2c34273acb9cb", "index": 6, "path": "999ae3ed__jinx__micro__llm__llm_cache.py\\11f2243296adaa6ea562c4fcd16c31c30d086380cf08cf959fb2c34273acb9cb.json", "terms": ["asyncio", "await", "timeout_task", "task", "out", "soft_timeout", "the", "done", "_dump_line", "timeout_sec", "cancel", "cancellederror", "else", "except", "inflight", "not", "return", "timeout", "true", "try", "_timeout_ms", "create_task", "first_completed", "output_text", "return_when"], "text_preview": "# Implement soft timeout without cancelling the underlying task\n        timeout_sec = max(0.1, _TIMEOUT_MS / 1000)\n        timeout_task = asyncio.create_task(asyncio.sleep(timeout_sec))\n        done, _ = await asyncio.wait({task, timeout_task}, return_when", "line_start": 194, "line_end": 220}, {"sha": "586d7a63445ae0f1f1aab7ab3404f216762e819e3291cddd91521aa12077f05a", "index": 7, "path": "999ae3ed__jinx__micro__llm__llm_cache.py\\586d7a63445ae0f1f1aab7ab3404f216762e819e3291cddd91521aa12077f05a.json", "terms": ["str", "the", "try", "base_extra_kwargs", "code_id", "temps_all", "await", "calls", "dict", "except", "getenv", "int", "max", "output", "res", "return", "small", "variations", "_dump_line", "call_openai_multi_validated", "hedge_ms", "input_text", "jinx_llm_multi_hedge_ms", "jinx_llm_multi_samples", "python_"], "text_preview": "if soft_timeout:\n        await _dump_line(\"awaiting inflight outside semaphore\")\n        try:\n            res = await fut\n            return str(res or \"\")\n        except BaseException as ex:\n            # Propagate the underlying error if the background t", "line_start": 221, "line_end": 254}, {"sha": "7ece270acb56c9cc2d181f8430af5307346d2552397a68015040c0febc61d77c", "index": 8, "path": "999ae3ed__jinx__micro__llm__llm_cache.py\\7ece270acb56c9cc2d181f8430af5307346d2552397a68015040c0febc61d77c.json", "terms": ["hedge_ms", "asyncio", "not", "temps", "except", "exception", "first", "true", "_one", "cancel_losers", "register_family", "max", "await", "start", "tasks", "temperature", "try", "__no_family__", "call_openai_cached", "create_task", "extra_kwargs", "input_text", "jinx_llm_multi_cancel", "wait_for", "additional"], "text_preview": "except Exception:\n        hedge_ms = 0\n    try:\n        cancel_losers = (os.getenv(\"JINX_LLM_MULTI_CANCEL\", \"1\").strip().lower() not in (\"\", \"0\", \"false\", \"off\", \"no\"))\n    except Exception:\n        cancel_losers = True\n\n    async def _one(t: float, regist", "line_start": 255, "line_end": 283}, {"sha": "33165772763d19ee38a68a3f0761dcd1e954aa152561aa0a8fc265d94131080a", "index": 9, "path": "999ae3ed__jinx__micro__llm__llm_cache.py\\33165772763d19ee38a68a3f0761dcd1e954aa152561aa0a8fc265d94131080a.json", "terms": ["none", "first", "out", "and", "except", "exception", "for", "fut", "good", "pairs", "return", "tasks", "try", "code_id", "not", "strip", "asyncio", "await", "cancel", "core", "earliest", "tag", "_one", "_parse_blocks", "as_completed"], "text_preview": "t1 = asyncio.create_task(_one(temps[1], False))\n            tasks.append(t1)\n\n    first: str | None = None\n    for fut in asyncio.as_completed(tasks):\n        try:\n            out = await fut\n        except Exception:\n            continue\n        if first ", "line_start": 284, "line_end": 316}], "file_terms": ["str", "asyncio", "return", "not", "except", "try", "none", "exception", "fut", "await", "model", "for", "input_text", "instructions", "key", "obj", "task", "import", "out", "the", "def", "dict", "first", "done", "and"]}