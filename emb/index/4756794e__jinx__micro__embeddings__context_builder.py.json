{"file_rel": "jinx\\micro\\embeddings\\context_builder.py", "file_sha256": "bd25aa48f4e6c31d04f3fa98553ea5de9cfd464c79c58b071f5d87160a625fb2", "updated_ts": 1760763310.914971, "total_chunks": 23, "chunks": [{"sha": "773f928ab62ed3289d5b03459fe6c34b57bfdef7baa13daba2ceb9530f7daf67", "index": 0, "path": "4756794e__jinx__micro__embeddings__context_builder.py\\773f928ab62ed3289d5b03459fe6c34b57bfdef7baa13daba2ceb9530f7daf67.json", "terms": ["import", "from", "jinx", "micro", "__future__", "_is_code_like", "build_snippet", "find_usages_cached", "format_literal_ref", "format_usage_ref", "get_cached_snippet", "get_python_symbol_at_line", "get_symbol_graph_cached", "graph_cache", "internal_paths", "is_code_like", "is_restricted_path", "lang_for_file", "make_snippet_cache_key", "proj_always_full_py_scope", "proj_callgraph_callees_limit", "proj_callgraph_callers_limit", "proj_callgraph_enabled", "proj_callgraph_time_ms", "proj_callgraph_top_hits"], "text_preview": "from __future__ import annotations\n\nimport os\nimport asyncio\nfrom typing import Any, Dict, List, Tuple\n\nfrom .project_rerank import rerank_hits\nfrom .project_config import ROOT\nfrom jinx.micro.common.internal_paths import is_restricted_path\nfrom .project_r", "line_start": 1, "line_end": 35}, {"sha": "e3a543018c9150316ddfc6c2dc31eda683f3837b8ec46bd03136be9ccb6cdded", "index": 1, "path": "4756794e__jinx__micro__embeddings__context_builder.py\\e3a543018c9150316ddfc6c2dc31eda683f3837b8ec46bd03136be9ccb6cdded.json", "terms": ["set", "str", "none", "int", "dedupe", "hits", "list", "query", "max_time_ms", "hits_sorted", "retrieve_project_top_k", "file", "from", "get", "header", "obj", "preview", "build_project_context_for", "file_hit_centers", "graph_headers_seen", "graph_parts", "headers_seen", "included_files", "line_start", "max_chars"], "text_preview": "from .retrieval_core import (\n    retrieve_project_top_k,\n    retrieve_project_multi_top_k,\n)\n\n\nasync def build_project_context_for(query: str, *, k: int | None = None, max_chars: int | None = None, max_time_ms: int | None = 300) -> str:\n    k = k or PROJ_", "line_start": 36, "line_end": 63}, {"sha": "2ce19b51ab012060990bf725241c1c961a2ad7ad111a237a4089bc38b93cdc8f", "index": 2, "path": "4756794e__jinx__micro__embeddings__context_builder.py\\2ce19b51ab012060990bf725241c1c961a2ad7ad111a237a4089bc38b93cdc8f.json", "terms": ["int", "_snip_conc", "file_rel", "else", "str", "except", "exception", "max_chars", "list", "none", "and", "budget", "continue", "idx", "try", "_is_code_like", "codey_query", "embed_project_snippet_conc", "extra_centers_abs", "file_hit_centers", "full_scope_used", "hits_sorted", "is_restricted_path", "line_end", "prefer_full"], "text_preview": "le = int(m.get(\"line_end\") or 0)\n            c = int((ls + le) // 2) if (ls and le) else int(ls or le or 0)\n            if c > 0:\n                file_hit_centers.setdefault(fr, []).append(c)\n        except Exception:\n            continue\n\n    # Disable to", "line_start": 64, "line_end": 90}, {"sha": "0c2370acbdea0533b0993668be62ff6de78608159a8a48339690c5eb11ce8aaa", "index": 3, "path": "4756794e__jinx__micro__embeddings__context_builder.py\\0c2370acbdea0533b0993668be62ff6de78608159a8a48339690c5eb11ce8aaa.json", "terms": ["extra_centers_abs", "int", "meta", "get", "proj_full_scope_top_n", "centers_i", "file_rel", "file_rel_i", "meta_i", "prefer_full", "prefer_full_i", "str", "and", "async", "def", "key", "seen", "try", "_build", "_run", "expand_callees", "file_hit_centers", "full_scope_used", "get_cached_snippet", "idx_i"], "text_preview": "pass\n        meta = obj.get(\"meta\", {})\n        pv = (meta.get(\"text_preview\") or \"\").strip()\n        if pv and pv in seen:\n            continue\n        if pv:\n            seen.add(pv)\n        prefer_full = PROJ_ALWAYS_FULL_PY_SCOPE and (\n            PROJ_", "line_start": 91, "line_end": 119}, {"sha": "3c265f6095ea74c12833d0e6387ba8e5135ada74c52667e3e751aa4105f55858", "index": 4, "path": "4756794e__jinx__micro__embeddings__context_builder.py\\3c265f6095ea74c12833d0e6387ba8e5135ada74c52667e3e751aa4105f55858.json", "terms": ["for", "asyncio", "res", "return", "code_c", "file_rel_i", "hdr_c", "is_full", "is_full_c", "le_c", "ls_c", "meta_i", "args", "await", "cached", "code", "exception", "hdr", "key", "not", "results", "tasks", "true", "_build", "_run"], "text_preview": "if cached is not None:\n                    hdr_c, code_c, ls_c, le_c, is_full_c = cached\n                    return (hdr_c, code_c, ls_c, le_c, is_full_c)\n                res = build_snippet(\n                    file_rel_i,\n                    meta_i,\n    ", "line_start": 120, "line_end": 143}, {"sha": "69e9faaea6406651dea0fb9d055aee26d7698723dae0786135008353fa4d27a3", "index": 5, "path": "4756794e__jinx__micro__embeddings__context_builder.py\\69e9faaea6406651dea0fb9d055aee26d7698723dae0786135008353fa4d27a3.json", "terms": ["file_rel", "snippet_text", "and", "not", "header", "is_full_scope", "parts", "would", "code_block", "headers_seen", "included_files", "proj_consolidate_per_file", "total_len", "use_le", "use_ls", "add", "append", "budget", "continue", "idx", "callers_limit", "full_scope_used", "get_symbol_graph_cached", "proj_always_full_py_scope", "proj_callgraph_callers_limit"], "text_preview": "idx, file_rel, meta, header, code_block, use_ls, use_le, is_full_scope = r\n        if PROJ_CONSOLIDATE_PER_FILE and file_rel in included_files:\n            continue\n        snippet_text = f\"{header}\\n{code_block}\"\n        if header in headers_seen:\n       ", "line_start": 144, "line_end": 170}, {"sha": "4ac54e3ce167e7c8840d14ac290f585d0cac77ad5d9415432e05138c462d9060", "index": 6, "path": "4756794e__jinx__micro__embeddings__context_builder.py\\4ac54e3ce167e7c8840d14ac290f585d0cac77ad5d9415432e05138c462d9060.json", "terms": ["hdr2", "str", "try", "_usage_lim_env", "for", "graph_headers_seen", "proj_usage_refs_limit", "usage_limit", "add", "block", "except", "exception", "list", "references", "tuple", "usage", "_collect_usages", "callees_limit", "file_text", "graph_parts", "jinx_refs_usage_limit", "proj_callgraph_callees_limit", "proj_callgraph_time_ms", "proj_max_files", "proj_snippet_around"], "text_preview": "callees_limit=PROJ_CALLGRAPH_CALLEES_LIMIT,\n                    around=PROJ_SNIPPET_AROUND,\n                    scan_cap_files=PROJ_MAX_FILES,\n                    time_budget_ms=PROJ_CALLGRAPH_TIME_MS,\n                )\n                for hdr2, block in (", "line_start": 171, "line_end": 196}, {"sha": "55dd1adbf26c9565702fee1701bf6797a18cc95c9c6f5fd39d3549c3b321fd6a", "index": 7, "path": "4756794e__jinx__micro__embeddings__context_builder.py\\55dd1adbf26c9565702fee1701bf6797a18cc95c9c6f5fd39d3549c3b321fd6a.json", "terms": ["file_text", "sym_name", "int", "use_le", "use_ls", "file_rel", "cand_line", "sym_kind", "and", "usages", "usnip", "find_usages_cached", "format_usage_ref", "get_python_symbol_at_line", "proj_snippet_around", "usage_limit", "around", "await", "blockx", "else", "encoding", "endswith", "errors", "except", "exception"], "text_preview": "with open(os.path.join(ROOT, file_rel), 'r', encoding='utf-8', errors='ignore') as _f:\n                            file_text = _f.read()\n                    except Exception:\n                        file_text = \"\"\n                    if file_rel.endswith('", "line_start": 197, "line_end": 214}, {"sha": "8fa3ecc858fca5a27447b95677dbae7a995bff66a07acee29e1f25398137b82d", "index": 8, "path": "4756794e__jinx__micro__embeddings__context_builder.py\\8fa3ecc858fca5a27447b95677dbae7a995bff66a07acee29e1f25398137b82d.json", "terms": ["else", "_lim_env", "langx", "int", "query", "_is_code_like", "_lim", "usnip", "blockx", "except", "exception", "hdrx", "literal", "out", "refs", "strip", "try", "ulang", "file_rel", "jinx_refs_lit_limit", "origin_file", "origin_le", "origin_ls", "use_le", "use_ls"], "text_preview": "ulang,\n                                        origin_file=file_rel,\n                                        origin_ls=int(use_ls or 0),\n                                        origin_le=int(use_le or 0),\n                                    )\n             ", "line_start": 215, "line_end": 233}, {"sha": "64ae988448369d5d106eedac57b8abb457c9dfa6ba45784ae8a023e875c1af63", "index": 9, "path": "4756794e__jinx__micro__embeddings__context_builder.py\\64ae988448369d5d106eedac57b8abb457c9dfa6ba45784ae8a023e875c1af63.json", "terms": ["int", "meta2", "get", "_ms_env", "_ms", "else", "query", "_is_code_like", "_lim", "_lit_call", "le2", "lit_hits", "ls2", "obj2", "rel2", "and", "str", "except", "exception", "return", "strip", "try", "_sc2", "file_rel", "jinx_refs_lit_ms"], "text_preview": "_ms_env = os.getenv(\"JINX_REFS_LIT_MS\", \"\")\n                            _ms = int(_ms_env) if _ms_env.strip() else (300 if _is_code_like(query or \"\") else 200)\n                        except Exception:\n                            _ms = 300 if _is_code_like", "line_start": 234, "line_end": 251}, {"sha": "11b36363d2be7d5ff5721183bdb87d4dfe6912502d17decca0efe626afad6655", "index": 10, "path": "4756794e__jinx__micro__embeddings__context_builder.py\\11b36363d2be7d5ff5721183bdb87d4dfe6912502d17decca0efe626afad6655.json", "terms": ["lang2", "prev", "int", "rel2", "blockx", "except", "exception", "hdrx", "le2", "ls2", "continue", "file_rel", "format_literal_ref", "lang_for_file", "origin_file", "origin_le", "origin_ls", "use_le", "use_ls", "append", "else", "not", "out", "query", "str"], "text_preview": "if not prev:\n                                    continue\n                                lang2 = lang_for_file(rel2)\n                                try:\n                                    hdrx, blockx = format_literal_ref(\n                              ", "line_start": 252, "line_end": 273}, {"sha": "59daae9b777c8dd2d7c3aa069bbd90c806057e3cb9793773a85d5978cc450883", "index": 11, "path": "4756794e__jinx__micro__embeddings__context_builder.py\\59daae9b777c8dd2d7c3aa069bbd90c806057e3cb9793773a85d5978cc450883.json", "terms": ["hdr3", "return", "refs_policy", "always", "except", "exception", "getenv", "int", "embeddings_code", "block3", "refs_headers_seen", "refs_max_chars", "refs_min", "bool", "default", "body", "false", "max", "out", "pairs", "parts", "try", "_collect_usages", "_should_send_refs", "jinx_refs_auto_min"], "text_preview": "return out\n                return out\n\n            pairs = await _collect_usages()\n            for hdr3, block3 in pairs:\n                if hdr3 in refs_headers_seen:\n                    continue\n                refs_headers_seen.add(hdr3)\n               ", "line_start": 274, "line_end": 305}, {"sha": "7a7ac6887d4c9df42c43fd5fe62b0b974628d99f634c72ad28456100c3f95ee5", "index": 12, "path": "4756794e__jinx__micro__embeddings__context_builder.py\\7a7ac6887d4c9df42c43fd5fe62b0b974628d99f634c72ad28456100c3f95ee5.json", "terms": ["none", "int", "len", "acc", "refs_parts", "out_blocks", "max", "queries", "str", "append", "join", "plen", "return", "total", "embeddings_graph", "embeddings_refs", "build_project_context_multi_for", "graph_parts", "k_eff", "gbody", "list", "rbody", "__all__", "_should_send_refs", "build_project_context_for"], "text_preview": "return True\n        return bool(codey) or (count >= refs_min)\n\n    if refs_parts and _should_send_refs(codey_query, len(refs_parts)):\n        # Trim refs to the configured character budget\n        acc: List[str] = []\n        total = 0\n        for p in refs", "line_start": 306, "line_end": 336}, {"sha": "00e8037ad6806ddaf770740f49631c55b9f7b346ade9fd29e95f81790f54dd19", "index": 13, "path": "4756794e__jinx__micro__embeddings__context_builder.py\\00e8037ad6806ddaf770740f49631c55b9f7b346ade9fd29e95f81790f54dd19.json", "terms": ["set", "str", "int", "hits", "list", "else", "get", "max_chars", "max_time_ms", "per_query_k", "file_hit_centers", "hits_sorted", "none", "all", "obj", "queries", "full_scope_used", "graph_headers_seen", "graph_parts", "headers_seen", "included_files", "line_end", "line_start", "proj_no_code_budget", "proj_total_code_budget"], "text_preview": "hits = await retrieve_project_multi_top_k(queries, per_query_k=per_query_k, max_time_ms=max_time_ms)\n    if not hits:\n        return \"\"\n    # Re-rank across all hits by combined query string\n    hits_sorted = rerank_hits(hits, \" \".join(queries))\n    parts:", "line_start": 337, "line_end": 364}, {"sha": "5ed85e49d78a57d7dee005df04a7b8caffff1933fa5ec1dd1529d0635e1f03e6", "index": 14, "path": "4756794e__jinx__micro__embeddings__context_builder.py\\5ed85e49d78a57d7dee005df04a7b8caffff1933fa5ec1dd1529d0635e1f03e6.json", "terms": ["int", "file_rel", "meta", "_snip_conc", "extra_centers_abs", "str", "continue", "except", "exception", "get", "try", "proj_full_scope_top_n", "prefer_full", "q_join", "list", "and", "for", "idx", "obj", "prepared", "seen", "semaphore", "_is_code_like", "codey_join", "embed_project_snippet_conc"], "text_preview": "continue\n\n    # Parallel snippet building with bounded semaphore\n    try:\n        _SNIP_CONC = max(1, int(os.getenv(\"EMBED_PROJECT_SNIPPET_CONC\", \"4\")))\n    except Exception:\n        _SNIP_CONC = 4\n    sem = asyncio.Semaphore(_SNIP_CONC)\n\n    q_join = \" \".", "line_start": 365, "line_end": 397}, {"sha": "0f93fe42176d1b60cb81be6cbb694ecdb328b0fcdd0c9ccdab33a7ac6b27a48a", "index": 15, "path": "4756794e__jinx__micro__embeddings__context_builder.py\\0f93fe42176d1b60cb81be6cbb694ecdb328b0fcdd0c9ccdab33a7ac6b27a48a.json", "terms": ["file_rel_i", "meta_i", "for", "asyncio", "header", "_build", "_run", "centers_i", "code_block", "file_rel", "idx_i", "is_full", "prefer_full_i", "args", "int", "str", "async", "await", "code", "continue", "def", "hdr", "results", "return", "tasks"], "text_preview": "async def _build(idx_i: int, file_rel_i: str, meta_i: Dict[str, Any], prefer_full_i: bool, centers_i: List[int]):\n        async with sem:\n            def _run():\n                return build_snippet(\n                    file_rel_i,\n                    meta", "line_start": 398, "line_end": 421}, {"sha": "6ef6f940ce922160c9b561eed214326e54c3a170b9c431fad29800d0fd32d0df", "index": 16, "path": "4756794e__jinx__micro__embeddings__context_builder.py\\6ef6f940ce922160c9b561eed214326e54c3a170b9c431fad29800d0fd32d0df.json", "terms": ["not", "file_rel", "snippet_text", "and", "parts", "would", "is_full_scope", "total_len", "add", "append", "budget", "for", "pairs", "callees_limit", "callers_limit", "full_scope_used", "get_symbol_graph_cached", "hdr2", "headers_seen", "included_files", "proj_always_full_py_scope", "proj_callgraph_callees_limit", "proj_callgraph_callers_limit", "proj_callgraph_enabled", "proj_callgraph_time_ms"], "text_preview": "headers_seen.add(header)\n        if budget is not None:\n            would = total_len + len(snippet_text)\n            if (not is_full_scope or not PROJ_ALWAYS_FULL_PY_SCOPE) and would > budget:\n                if not parts:\n                    parts.append", "line_start": 422, "line_end": 448}, {"sha": "0e929d10dec028ce094757e0434ea5984c1690338e7a3252f5fe178c5c843f4b", "index": 17, "path": "4756794e__jinx__micro__embeddings__context_builder.py\\0e929d10dec028ce094757e0434ea5984c1690338e7a3252f5fe178c5c843f4b.json", "terms": ["file_text", "str", "use_le", "use_ls", "hdr2", "try", "cand_line", "file_rel", "graph_headers_seen", "sym_name", "int", "add", "and", "except", "exception", "list", "tuple", "_collect_usages", "get_python_symbol_at_line", "graph_parts", "sym_kind", "append", "async", "block", "continue"], "text_preview": "if hdr2 in graph_headers_seen:\n                        continue\n                    graph_headers_seen.add(hdr2)\n                    graph_parts.append(f\"{hdr2}\\n{block}\")\n        except Exception:\n            pass\n        # Optionally add a couple of usag", "line_start": 449, "line_end": 469}, {"sha": "d54e645116271b8c32af16253200e5da28d6e43141e57c463f1b91cc5cf5e273", "index": 18, "path": "4756794e__jinx__micro__embeddings__context_builder.py\\d54e645116271b8c32af16253200e5da28d6e43141e57c463f1b91cc5cf5e273.json", "terms": ["usnip", "int", "langx", "ulang", "file_rel", "sym_name", "blockx", "hdrx", "usages", "find_usages_cached", "format_usage_ref", "origin_file", "origin_le", "origin_ls", "proj_snippet_around", "proj_usage_refs_limit", "sym_kind", "use_le", "use_ls", "around", "await", "else", "except", "exception", "for"], "text_preview": "usages = await find_usages_cached(sym_name, file_rel, limit=PROJ_USAGE_REFS_LIMIT, around=PROJ_SNIPPET_AROUND)\n                            for fr, ua, ub, usnip, ulang in usages:\n                                try:\n                                    hdrx", "line_start": 470, "line_end": 488}, {"sha": "7b83d533528b363db7ae5aa243ee290ae0d2de4eee37cbdd53471494217217c2", "index": 19, "path": "4756794e__jinx__micro__embeddings__context_builder.py\\7b83d533528b363db7ae5aa243ee290ae0d2de4eee37cbdd53471494217217c2.json", "terms": ["else", "q_join", "_is_code_like", "_lim_env", "_ms_env", "_lim", "_ms", "except", "exception", "strip", "try", "getenv", "int", "literal", "out", "refs", "return", "_lit_call", "jinx_refs_lit_limit", "jinx_refs_lit_ms", "max_time_ms", "stage_literal_hits", "and", "append", "blockx"], "text_preview": "out.append((hdrx, blockx))\n                    # Fallback: literal-occurrences refs when no symbol usages were found\n                    if not out and (q_join or \"\").strip():\n                        # Literal refs collection tuning via env\n               ", "line_start": 489, "line_end": 507}, {"sha": "3b1123782e8563c8d4011ad75dada0d61bf9d906c7f9cea7d8340346ad73ba83", "index": 20, "path": "4756794e__jinx__micro__embeddings__context_builder.py\\3b1123782e8563c8d4011ad75dada0d61bf9d906c7f9cea7d8340346ad73ba83.json", "terms": ["int", "meta2", "get", "rel2", "prev", "lang2", "le2", "lit_hits", "ls2", "obj2", "try", "_lim", "_lit_call", "_sc2", "file_rel", "format_literal_ref", "lang_for_file", "line_end", "line_start", "origin_file", "origin_ls", "q_join", "text_preview", "to_thread", "use_ls"], "text_preview": "lit_hits = await asyncio.to_thread(_lit_call)\n                        for _sc2, rel2, obj2 in (lit_hits or [])[:_lim]:\n                            try:\n                                meta2 = (obj2.get(\"meta\") or {})\n                                ls2 = i", "line_start": 508, "line_end": 527}, {"sha": "9d730ae88d5b1078472dfcde9ff545cd541ad84200ffdf686568f33c088641da", "index": 21, "path": "4756794e__jinx__micro__embeddings__context_builder.py\\9d730ae88d5b1078472dfcde9ff545cd541ad84200ffdf686568f33c088641da.json", "terms": ["hdr3", "except", "exception", "out", "return", "embeddings_code", "lang2", "block3", "refs_headers_seen", "default", "prev", "refs", "always", "append", "blockx", "body", "continue", "hdrx", "pairs", "parts", "_collect_usages", "jinx_refs_policy", "le2", "ls2", "origin_le"], "text_preview": "origin_le=int(use_le or 0),\n                                    )\n                                except Exception:\n                                    hdrx = f\"[{rel2}:{ls2}-{le2}]\"\n                                    blockx = f\"```{lang2}\\n{prev}\\n```\" i", "line_start": 528, "line_end": 554}, {"sha": "816066d7366bcc6feb9aa98cf10fd923a00e7cf812bdbee46bb75ca01a067d67", "index": 22, "path": "4756794e__jinx__micro__embeddings__context_builder.py\\816066d7366bcc6feb9aa98cf10fd923a00e7cf812bdbee46bb75ca01a067d67.json", "terms": ["acc", "return", "refs_parts", "out_blocks", "refs_max_chars", "refs_min", "bool", "append", "int", "join", "plen", "total", "embeddings_graph", "embeddings_refs", "_should_send_refs_multi", "graph_parts", "refs_policy", "codey", "count", "except", "exception", "false", "gbody", "getenv", "len"], "text_preview": "try:\n        refs_min = max(1, int(os.getenv(\"JINX_REFS_AUTO_MIN\", \"2\")))\n    except Exception:\n        refs_min = 2\n    try:\n        refs_max_chars = max(200, int(os.getenv(\"JINX_REFS_MAX_CHARS\", \"1600\")))\n    except Exception:\n        refs_max_chars = 16", "line_start": 555, "line_end": 586}], "file_terms": ["int", "str", "exception", "try", "except", "file_rel", "and", "for", "else", "return", "list", "append", "set", "get", "not", "continue", "none", "from", "import", "use_le", "use_ls", "query", "meta", "await", "getenv"]}