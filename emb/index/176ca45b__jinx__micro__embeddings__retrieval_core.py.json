{"file_rel": "jinx\\micro\\embeddings\\retrieval_core.py", "file_sha256": "e05ba29dfdb5ae19eee2fcb2b9495df4eb10ed18628ca518836d7760ebdafc7f", "updated_ts": 1760763311.7830513, "total_chunks": 15, "chunks": [{"sha": "6b51f7e88b9a8aec82f85dec898b35d0dfa0ef5af5f9d612132a34a154b612ba", "index": 0, "path": "176ca45b__jinx__micro__embeddings__retrieval_core.py\\6b51f7e88b9a8aec82f85dec898b35d0dfa0ef5af5f9d612132a34a154b612ba.json", "terms": ["import", "str", "dict", "tuple", "from", "any", "int", "list", "_prj_ttl_ms", "float", "__future__", "_prj_cache", "_prj_multi_cache", "jinx_proj_retr_ttl_ms", "proj_default_top_k", "proj_exhaustive_mode", "proj_literal_burst_ms", "proj_no_stage_budgets", "proj_stage_astcontains_ms", "proj_stage_astmatch_ms", "proj_stage_cooccur_ms", "proj_stage_exact_ms", "proj_stage_jedi_ms", "proj_stage_keyword_ms", "proj_stage_libcst_ms"], "text_preview": "from __future__ import annotations\n\nimport os\nimport time\nimport asyncio\nimport re\nfrom typing import Any, Dict, List, Tuple\n\n# TTL caches for retrieval results\n_PRJ_CACHE: Dict[str, Tuple[int, List[Tuple[float, str, Dict[str, Any]]]]] = {}\n_PRJ_MULTI_CACH", "line_start": 1, "line_end": 43}, {"sha": "8a13d24cdf4f36ea7d6a2ab9b226162bd06a2fbbe328525bf478c28a2ac2b2b3", "index": 1, "path": "176ca45b__jinx__micro__embeddings__retrieval_core.py\\8a13d24cdf4f36ea7d6a2ab9b226162bd06a2fbbe328525bf478c28a2ac2b2b3.json", "terms": ["_is_code_like", "extract_code_core", "is_code_like", "project_query_core", "project_stage_astcontains", "project_stage_astmatch", "project_stage_cooccur", "project_stage_jedi", "project_stage_keyword", "project_stage_libcst", "project_stage_lineexact", "project_stage_literal", "project_stage_openbuffer", "project_stage_pyast", "project_stage_pydoc", "project_stage_pyflow", "project_stage_pyliterals", "project_stage_rapidfuzz", "project_stage_regex", "project_stage_textscan", "project_stage_tokenmatch", "project_stage_traceback", "stage_astcontains_hits", "stage_astmatch_hits", "stage_cooccur_hits"], "text_preview": "from .project_stage_keyword import stage_keyword_hits\nfrom .project_stage_textscan import stage_textscan_hits\nfrom .project_stage_jedi import stage_jedi_hits\nfrom .project_stage_pyast import stage_pyast_hits\nfrom .project_stage_pydoc import stage_pydoc_hit", "line_start": 44, "line_end": 65}, {"sha": "c78b0c6887beeef0d91685c618bba4b814714da854f8a47d1564531a738d4b47", "index": 2, "path": "176ca45b__jinx__micro__embeddings__retrieval_core.py\\c78b0c6887beeef0d91685c618bba4b814714da854f8a47d1564531a738d4b47.json", "terms": ["str", "tuple", "none", "get", "int", "ent", "any", "dict", "float", "list", "return", "k_eff", "now_ms", "time", "def", "query", "_prj_ttl_ms", "_obj", "_rel", "set", "hit", "hits", "not", "_key_of", "_merge"], "text_preview": "async def retrieve_project_top_k(query: str, k: int | None = None, *, max_time_ms: int | None = 250) -> List[Tuple[float, str, Dict[str, Any]]]:\n    q = (query or \"\").strip()\n    if not q:\n        return []\n    k_eff = k or PROJ_DEFAULT_TOP_K\n    # TTL cac", "line_start": 66, "line_end": 96}, {"sha": "abae99bab5eef86ef8362cc01084434a128f443ac1e8325563d0ee2fda87ed06", "index": 3, "path": "176ca45b__jinx__micro__embeddings__retrieval_core.py\\abae99bab5eef86ef8362cc01084434a128f443ac1e8325563d0ee2fda87ed06.json", "terms": ["none", "int", "rem", "return", "cap_ms", "hits", "def", "_bounded", "k_arg", "max_time_ms", "_call", "_time_left", "seen_keys", "stage_fn", "caps", "max", "per", "query", "stage", "_key_of", "_run_sync_stage", "perf_counter", "proj_exhaustive_mode", "proj_no_stage_budgets", "to_thread"], "text_preview": "for h in hits:\n            kx = _key_of(h)\n            if kx in seen_keys:\n                continue\n            seen_keys.add(kx)\n            collected.append(h)\n\n    # Helper closures to minimize repetition across stages\n    def _time_left() -> int | None", "line_start": 97, "line_end": 129}, {"sha": "54a372e9eed48a0ff815f151833675f3832a773aa48e4f057c9b7e40a9685af6", "index": 4, "path": "176ca45b__jinx__micro__embeddings__retrieval_core.py\\54a372e9eed48a0ff815f151833675f3832a773aa48e4f057c9b7e40a9685af6.json", "terms": ["asyncio", "k_arg", "hits", "int", "str", "return", "proj_stage_lineexact_ms", "_bounded", "_call", "_time_left", "cap_ms", "codey_early", "create_task", "max_time_ms", "rem_vec0", "stage_fn", "vec_task", "def", "else", "except", "exception", "query", "run", "try", "_is_code_like"], "text_preview": "async def _run_sync_stage_forced(stage_fn, query: str, k_arg: int, cap_ms: int):\n        \"\"\"Run a sync stage with its own cap, ignoring overall remaining time.\"\"\"\n        def _call():\n            try:\n                return stage_fn(query, k_arg, max_time_", "line_start": 130, "line_end": 150}, {"sha": "95886cae5937eac2d1e73a6530ad045d5f10eaa4ea6167aca5e19c6868f10a4f", "index": 5, "path": "176ca45b__jinx__micro__embeddings__retrieval_core.py\\95886cae5937eac2d1e73a6530ad045d5f10eaa4ea6167aca5e19c6868f10a4f.json", "terms": ["_run_sync_stage", "q_core", "k_eff", "await", "tm_hits", "asyncio", "hits", "results", "proj_stage_literal_ms", "cap_literal", "proj_stage_tokenmatch_ms", "stage_tokenmatch_hits", "else", "sleep", "tasks", "_bounded", "_is_code_like", "_merge", "_time_left", "cap_lineexact", "codey_early", "codey_seq", "proj_stage_astmatch_ms", "proj_stage_rapidfuzz_ms", "return_exceptions"], "text_preview": "cap_literal = _bounded(_time_left(), int(PROJ_STAGE_LITERAL_MS * (1.5 if codey_early else 1.0))) or PROJ_STAGE_LITERAL_MS\n        tasks = [\n            _run_sync_stage(stage_tokenmatch_hits, q_core, k_eff, PROJ_STAGE_TOKENMATCH_MS),\n            _run_sync_s", "line_start": 151, "line_end": 174}, {"sha": "797bc00ebd5f5c8d994ebbe92a203f335a7d236a531158827d3aa429e54dc64a", "index": 6, "path": "176ca45b__jinx__micro__embeddings__retrieval_core.py\\797bc00ebd5f5c8d994ebbe92a203f335a7d236a531158827d3aa429e54dc64a.json", "terms": ["await", "_run_sync_stage", "q_core", "asyncio", "return", "sleep", "am_hits", "codey_seq", "le_hits", "lit_early", "ob_hits", "else", "proj_stage_lineexact_ms", "proj_stage_literal_ms", "_bounded", "_time_left", "cap_lineexact2", "cap_literal2", "ast", "exact", "code", "int", "proj_stage_astmatch_ms", "stage_astmatch_hits", "stage_lineexact_hits"], "text_preview": "cap_lineexact2 = _bounded(_time_left(), int(PROJ_STAGE_LINEEXACT_MS * (1.5 if codey_seq else 1.0))) or PROJ_STAGE_LINEEXACT_MS\n        le_hits = await _run_sync_stage(stage_lineexact_hits, q_core, 1, cap_lineexact2)\n        if le_hits:\n            return l", "line_start": 175, "line_end": 199}, {"sha": "47f8397d37c8e20f47cbdd08b7b8e1cb81be0b1efd63d01c6e2d3e369662a270", "index": 7, "path": "176ca45b__jinx__micro__embeddings__retrieval_core.py\\47f8397d37c8e20f47cbdd08b7b8e1cb81be0b1efd63d01c6e2d3e369662a270.json", "terms": ["await", "_qr", "_run_sync_stage", "ac_hits", "assign_like", "co_hits", "comp_like", "rf_hits", "qlow", "asyncio", "return", "sleep", "q_core", "for", "sym", "and", "false", "query", "try", "proj_stage_astcontains_ms", "proj_stage_cooccur_ms", "proj_stage_rapidfuzz_ms", "stage_astcontains_hits", "stage_cooccur_hits", "stage_rapidfuzz_hits"], "text_preview": "ac_hits = await _run_sync_stage(stage_astcontains_hits, q, 1, PROJ_STAGE_ASTCONTAINS_MS)\n        if ac_hits:\n            return ac_hits[:1]\n        await asyncio.sleep(0)\n\n        rf_hits = await _run_sync_stage(stage_rapidfuzz_hits, q_core, 1, PROJ_STAGE_", "line_start": 200, "line_end": 227}, {"sha": "4213246c8a91bdc7de05caa703d4bce8c926d489e12f2a338880475645364840", "index": 8, "path": "176ca45b__jinx__micro__embeddings__retrieval_core.py\\4213246c8a91bdc7de05caa703d4bce8c926d489e12f2a338880475645364840.json", "terms": ["await", "k_eff", "vec_hits0", "_run_sync_stage", "pf0", "accumulate", "else", "asyncio", "proj_stage_pre_ms", "_merge", "codey", "return", "sleep", "try", "_is_code_like", "cap_pre", "proj_stage_pyast_ms", "proj_stage_pydoc_ms", "proj_stage_pyflow_ms", "proj_stage_tb_ms", "q_core", "res_a", "stage_pyast_hits", "stage_pydoc_hits", "stage_pyflow_hits"], "text_preview": "pf0 = await _run_sync_stage(stage_pyflow_hits, q_core, (k_eff if accumulate else 1), PROJ_STAGE_PYFLOW_MS)\n        if pf0:\n            if accumulate:\n                _merge(pf0)\n            else:\n                return pf0[:1]\n        await asyncio.sleep(0", "line_start": 228, "line_end": 258}, {"sha": "f493c4ac080b8d39d1a52bd58a0a69757fcca0bf643682f92a0e9218d4f278ab", "index": 9, "path": "176ca45b__jinx__micro__embeddings__retrieval_core.py\\f493c4ac080b8d39d1a52bd58a0a69757fcca0bf643682f92a0e9218d4f278ab.json", "terms": ["_run_sync_stage", "k_eff", "hits", "res_b", "asyncio", "await", "_merge", "res_a", "return_exceptions", "except", "exception", "for", "group", "isinstance", "list", "sleep", "true", "try", "proj_stage_astcontains_ms", "proj_stage_jedi_ms", "proj_stage_libcst_ms", "proj_stage_pyflow_ms", "proj_stage_pyliterals_ms", "proj_stage_regex_ms", "stage_astcontains_hits"], "text_preview": "_run_sync_stage(stage_pyliterals_hits, q, k_eff, PROJ_STAGE_PYLITERALS_MS),\n                return_exceptions=True,\n            )\n        except Exception:\n            res_a = []\n        for hits in res_a:\n            if isinstance(hits, list):\n           ", "line_start": 259, "line_end": 287}, {"sha": "5a2e6a45b682bd1a3dbe79f9bffac258a34000bec37255e550cea0c2f2ba36a1", "index": 10, "path": "176ca45b__jinx__micro__embeddings__retrieval_core.py\\5a2e6a45b682bd1a3dbe79f9bffac258a34000bec37255e550cea0c2f2ba36a1.json", "terms": ["k_eff", "_run_sync_stage", "await", "burst_ms", "res_c", "hits", "_merge", "q_core", "stage_literal_hits", "asyncio", "except", "exception", "_run_sync_stage_forced", "cap_pre", "lit_res", "proj_literal_burst_ms", "proj_stage_cooccur_ms", "proj_stage_exact_ms", "proj_stage_keyword_ms", "proj_stage_literal_ms", "return_exceptions", "stage_cooccur_hits", "stage_exact_hits", "stage_keyword_hits", "stage_openbuffer_hits"], "text_preview": "res_c = await asyncio.gather(\n                _run_sync_stage(stage_textscan_hits, q, k_eff, cap_pre),\n                _run_sync_stage(stage_exact_hits, q, k_eff, PROJ_STAGE_EXACT_MS),\n                _run_sync_stage(stage_literal_hits, (q_core or q), k_ef", "line_start": 288, "line_end": 312}, {"sha": "570a1148c2213dc2e1b5e609da8b189d7bc6c09f04c884b279f41437152ea6ef", "index": 11, "path": "176ca45b__jinx__micro__embeddings__retrieval_core.py\\570a1148c2213dc2e1b5e609da8b189d7bc6c09f04c884b279f41437152ea6ef.json", "terms": ["await", "return", "k_eff", "stage", "_run_sync_stage", "asyncio", "sleep", "ast_hits", "out_hits", "pl_hits", "pydoc_hits", "tb_hits", "lit_res", "list", "sorted", "_merge", "_prj_cache", "now_ms", "proj_stage_pyast_ms", "proj_stage_pydoc_ms", "proj_stage_pyliterals_ms", "proj_stage_tb_ms", "stage_pyast_hits", "stage_pydoc_hits", "stage_pyliterals_hits"], "text_preview": "if isinstance(lit_res, list):\n                _merge(lit_res)\n\n        # Return deduped, score-sorted\n        out_hits = sorted(collected, key=lambda h: float(h[0] or 0.0), reverse=True)[:k_eff]\n        try:\n            _PRJ_CACHE[ck] = (now_ms, list(out_h", "line_start": 313, "line_end": 348}, {"sha": "b2c433f94a98afa6db74734634fc664ff975a1f69202285a2f2541d09b585dc9", "index": 12, "path": "176ca45b__jinx__micro__embeddings__retrieval_core.py\\b2c433f94a98afa6db74734634fc664ff975a1f69202285a2f2541d09b585dc9.json", "terms": ["await", "_run_sync_stage", "k_eff", "asyncio", "return", "sleep", "stage", "cst_hits", "jedi_hits", "pyflow_hits", "rx_hits", "txt_hits", "proj_stage_pre_ms", "cap_pre", "codey", "exact", "_is_code_like", "proj_stage_exact_ms", "proj_stage_jedi_ms", "proj_stage_libcst_ms", "proj_stage_pyflow_ms", "proj_stage_regex_ms", "stage_exact_hits", "stage_jedi_hits", "stage_libcst_hits"], "text_preview": "pyflow_hits = await _run_sync_stage(stage_pyflow_hits, q, k_eff, PROJ_STAGE_PYFLOW_MS)\n        if pyflow_hits:\n            return pyflow_hits\n        await asyncio.sleep(0)\n\n        # Stage -1.6: libcst\n        cst_hits = await _run_sync_stage(stage_libcst", "line_start": 349, "line_end": 381}, {"sha": "eefbaf4205c3f7c5b00e2afd7de592202bfb4abb13c0dc531511f0221b416e36", "index": 13, "path": "176ca45b__jinx__micro__embeddings__retrieval_core.py\\eefbaf4205c3f7c5b00e2afd7de592202bfb4abb13c0dc531511f0221b416e36.json", "terms": ["out_hits", "now_ms", "ent", "list", "return", "k_eff", "lit_hits", "str", "int", "await", "_prj_ttl_ms", "_run_sync_stage", "max_time_ms", "per_query_k", "strip", "time", "exact", "except", "exception", "none", "not", "pass", "queries", "try", "_prj_cache"], "text_preview": "if exact:\n            return exact\n        await asyncio.sleep(0)\n\n        # Stage 2: keyword\n        kw = (await _run_sync_stage(stage_keyword_hits, q, k_eff, PROJ_STAGE_KEYWORD_MS)) or []\n        out_hits = kw[:k_eff]\n        # Final literal pass\n       ", "line_start": 382, "line_end": 415}, {"sha": "fc780e85fe7469d6893b565b41e3424f2cf969e8ee1f48a46ddcf2daa41b3836", "index": 14, "path": "176ca45b__jinx__micro__embeddings__retrieval_core.py\\fc780e85fe7469d6893b565b41e3424f2cf969e8ee1f48a46ddcf2daa41b3836.json", "terms": ["str", "get", "hits", "key", "per_budget", "asyncio", "int", "float", "list", "merged", "obj", "out", "rel", "results", "seen", "tuple", "_run_one", "file_rel", "max_time_ms", "per_query_k", "max", "set", "any", "async", "await"], "text_preview": "per_budget = None\n    else:\n        per_budget = max(50, int(max_time_ms // max(1, len(qs))))\n    sem = asyncio.Semaphore(3)\n    results: List[Tuple[float, str, Dict[str, Any]]] = []\n\n    async def _run_one(q: str) -> None:\n        async with sem:\n        ", "line_start": 416, "line_end": 450}], "file_terms": ["await", "_run_sync_stage", "k_eff", "return", "asyncio", "int", "str", "import", "hits", "from", "sleep", "list", "q_core", "none", "try", "except", "exception", "tuple", "else", "stage", "dict", "for", "any", "float", "max_time_ms"]}