{"file_rel": "jinx\\micro\\runtime\\handlers\\refactor_handler.py", "file_sha256": "613da6f6d803feb8dfb91d8119ded8d09f587f8e05f0255955b79a3d1ba18d74", "updated_ts": 1760763313.1981955, "total_chunks": 15, "chunks": [{"sha": "1978dbd52811919a3528a6b91b7026fe0d0f15724022cb75209325bf224bb27b", "index": 0, "path": "50555d16__jinx__micro__runtime__handlers__refactor_handler.py\\1978dbd52811919a3528a6b91b7026fe0d0f15724022cb75209325bf224bb27b.json", "terms": ["str", "import", "from", "micro", "jinx", "return", "path", "runtime", "project_root", "none", "the", "awaitable", "base", "callable", "def", "default", "handlers", "list", "modules", "name", "not", "__future__", "_abs_path", "_h_batch", "_truthy"], "text_preview": "from __future__ import annotations\n\n# DEPRECATED: This module has been split into micro-modules:\n#  - refactor_utils.py\n#  - refactor_imports.py\n#  - refactor_move.py\n#  - refactor_split.py\n# It is kept for historical reference; the handlers package re-exp", "line_start": 1, "line_end": 36}, {"sha": "fc60b8c28786ed32a6367d33e5022ae200caaec1d01f07d8537df956a39b76f1", "index": 1, "path": "50555d16__jinx__micro__runtime__handlers__refactor_handler.py\\fc60b8c28786ed32a6367d33e5022ae200caaec1d01f07d8537df956a39b76f1.json", "terms": ["rel", "str", "path", "lines", "seg", "def", "else", "return", "and", "endswith", "parts", "root", "coding", "docstring", "encoding", "line", "shebang", "startswith", "text", "__init__", "_abs_path", "_ensure_newline", "_import_insertion_index", "_module_name_from_path", "_read"], "text_preview": "return True\n\n\ndef _module_name_from_path(path: str) -> str:\n    ap = _abs_path(path)\n    root = os.path.normpath(PROJECT_ROOT or os.getcwd())\n    if ap.startswith(root):\n        rel = os.path.relpath(ap, root)\n    else:\n        rel = ap\n    if rel.endswith", "line_start": 37, "line_end": 77}, {"sha": "d9b00990ce10c64642b683ed34fbe28125ab5a6eaa6a7d9c7268ada662652b9d", "index": 2, "path": "50555d16__jinx__micro__runtime__handlers__refactor_handler.py\\d9b00990ce10c64642b683ed34fbe28125ab5a6eaa6a7d9c7268ada662652b9d.json", "terms": ["str", "lines", "and", "line", "list", "lstrip", "startswith", "ops", "quote", "strip", "return", "while", "dst_path", "bool", "dict", "meta", "batch", "def", "else", "import", "symbol", "__future__", "__init__", "_append_unique_line", "_build_move_plan"], "text_preview": "while i < n and not lines[i].strip():\n        i += 1\n    if i < n and (lines[i].lstrip().startswith(\"\\\"\\\"\\\"\") or lines[i].lstrip().startswith(\"'''\")):\n        quote = '\"\"\"' if lines[i].lstrip().startswith('\"\"\"') else \"'''\"\n        # advance to closing\n    ", "line_start": 78, "line_end": 105}, {"sha": "50148dded935012e35ac475f217a466bfb6d1b9970533b47b8eeecdda69218d1", "index": 3, "path": "50555d16__jinx__micro__runtime__handlers__refactor_handler.py\\50148dded935012e35ac475f217a466bfb6d1b9970533b47b8eeecdda69218d1.json", "terms": ["src_lines", "dst_new", "meta", "ap_dst", "ap_src", "dst_text", "true", "await", "code", "get", "not", "_abs_path", "_read", "src_text", "and", "content", "destination", "else", "endswith", "int", "len", "max", "min", "prepare", "symbol"], "text_preview": "\"\"\"\n    ap_src = _abs_path(src_path)\n    ap_dst = _abs_path(dst_path)\n    ok, code, meta = await extract_symbol_source(ap_src, symbol, include_decorators=True, include_docstring=True)\n    if not ok:\n        raise RuntimeError(f\"extract failed: {meta.get('e", "line_start": 106, "line_end": 138}, {"sha": "2fdc94486c31912728b0268ca789cdedf6d0cb338ee041b087d901d0ac07f0cc", "index": 4, "path": "50555d16__jinx__micro__runtime__handlers__refactor_handler.py\\2fdc94486c31912728b0268ca789cdedf6d0cb338ee041b087d901d0ac07f0cc.json", "terms": ["symbol", "kept", "init_text", "idx", "path", "write", "ap_dst", "dst_mod", "import", "file", "join", "ops", "__init__", "dst_dir", "import_line", "init_path", "src_new", "append", "code", "destination", "from", "meta", "move", "refactor", "role"], "text_preview": "# Compose import binding: from <dst_mod> import <symbol>\n        dst_mod = _module_name_from_path(ap_dst)\n        import_line = f\"from {dst_mod} import {symbol}\"\n        idx = _import_insertion_index(\"\\n\".join(kept))\n        # insert after idx\n        kept", "line_start": 139, "line_end": 164}, {"sha": "8a605782202fc8c19177b5e422197b31cef18eb509c8e30ba1bd12ca8d60548c", "index": 5, "path": "50555d16__jinx__micro__runtime__handlers__refactor_handler.py\\8a605782202fc8c19177b5e422197b31cef18eb509c8e30ba1bd12ca8d60548c.json", "terms": ["lines", "symbol", "str", "new_mod", "old_mod", "_module_name_from_path", "ap_dst", "export_line", "path", "append", "import", "ops", "_scan_and_rewrite_imports", "init_new", "more_ops", "rel_mod", "from", "project", "rewrite", "strip", "_ensure_newline", "_truthy", "ap_src", "dst_init", "dst_module"], "text_preview": "rel_mod = os.path.splitext(os.path.basename(ap_dst))[0]\n        export_line = f\"from .{rel_mod} import {symbol}\"\n        lines = init_text.splitlines()\n        if not any(ln.strip() == export_line for ln in lines):\n            if lines and lines[-1].strip(", "line_start": 165, "line_end": 187}, {"sha": "f203563315425b0299afe75e91b3720741cb863fc60850d55fb22fd366ea8e78", "index": 6, "path": "50555d16__jinx__micro__runtime__handlers__refactor_handler.py\\f203563315425b0299afe75e91b3720741cb863fc60850d55fb22fd366ea8e78.json", "terms": ["continue", "for", "from", "not", "old_mod", "dirnames", "alias", "import", "lines", "list", "text", "dirpath", "filenames", "path", "root", "the", "try", "_read", "exclude_dirs", "project_root", "avoid", "await", "changed", "changing", "check"], "text_preview": "Only rewrites lines where the imported list is a single name (optionally 'as alias'), to avoid\n    changing imports of other symbols from old_mod. Preserves alias.\n    \"\"\"\n    root = os.path.normpath(PROJECT_ROOT or os.getcwd())\n    ops: List[Dict[str, obj", "line_start": 188, "line_end": 216}, {"sha": "6bb9c239166a4209ff1b09153ea921a99271dc5bb4c77a927ea9a5331378c0d8", "index": 7, "path": "50555d16__jinx__micro__runtime__handlers__refactor_handler.py\\6bb9c239166a4209ff1b09153ea921a99271dc5bb4c77a927ea9a5331378c0d8.json", "terms": ["strip", "split", "entry", "parts", "symbol", "new_line", "after", "import", "code_part", "names_raw", "base", "before", "case", "continue", "exactly", "for", "from", "new_mod", "old_mod", "alias", "but", "changed", "comment", "containing", "content"], "text_preview": "before, _, after = ln.partition(f\"from {old_mod} import \")\n                    if not after:\n                        continue\n                    # strip trailing comment but keep content\n                    code_part, *_ = after.split(\"#\", 1)\n            ", "line_start": 217, "line_end": 236}, {"sha": "e98982f3d77d1f38c7fcf959f1d494f00356e35d072d07924806fe9528e4cc74", "index": 8, "path": "50555d16__jinx__micro__runtime__handlers__refactor_handler.py\\e98982f3d77d1f38c7fcf959f1d494f00356e35d072d07924806fe9528e4cc74.json", "terms": ["move_entry", "alias", "none", "new_mod", "keep_parts", "new_lines_block", "append", "base", "continue", "from", "import", "indent", "split", "strip", "symbol", "_truthy", "jinx_refactor_rewrite_grouped_imports", "old_mod", "and", "before", "else", "entry", "for", "includes", "keep"], "text_preview": "if not _truthy(\"JINX_REFACTOR_REWRITE_GROUPED_IMPORTS\", \"1\"):\n                            continue\n                        # keep others in old_mod, move our entry to new_mod on a new line\n                        keep_parts = []\n                        mov", "line_start": 237, "line_end": 257}, {"sha": "fd3f37b26f2bca54e581951b2de7a328b939739c2f8ac7bd5ed7a6d323a33349", "index": 9, "path": "50555d16__jinx__micro__runtime__handlers__refactor_handler.py\\fd3f37b26f2bca54e581951b2de7a328b939739c2f8ac7bd5ed7a6d323a33349.json", "terms": ["str", "from", "symbol", "none", "bool", "import", "lines", "optional", "dst_path", "keep_parts", "new_lines_block", "new_text", "old_mod", "src_path", "and", "append", "changed", "code", "exports", "join", "ops", "the", "top", "with", "create_init"], "text_preview": "# from old_mod import other1, other2 (if any left)\n                        if keep_parts:\n                            new_lines_block.append(indent + f\"from {old_mod} import {', '.join(keep_parts)}\")\n                        # replace the single line with 1", "line_start": 258, "line_end": 287}, {"sha": "e69d4fead7f48f2dd2e84516c7aa3dc78b6e8d12c3f0563b4042da6ce33e1190", "index": 10, "path": "50555d16__jinx__micro__runtime__handlers__refactor_handler.py\\e69d4fead7f48f2dd2e84516c7aa3dc78b6e8d12c3f0563b4042da6ce33e1190.json", "terms": ["str", "await", "none", "tid", "create_init", "insert_shim", "verify_cb", "_truthy", "exports", "force", "batch", "bool", "else", "not", "report_progress", "src_path", "handler", "move", "ops", "optional", "preview", "refactor", "symbol", "__init__", "_build_move_plan"], "text_preview": "- Optionally updates __init__.py in destination package to re-export symbol\n    - Runs through batch handler to preserve preview/gate/commit/watchdog/verify\n    \"\"\"\n    try:\n        await report_progress(tid, 9.0, \"build move plan\")\n        ci = create_ini", "line_start": 288, "line_end": 312}, {"sha": "8dd7f3ae0de6cd7987f49d78c1d06ade94435c217ac299ae9b2048471b7029e4", "index": 11, "path": "50555d16__jinx__micro__runtime__handlers__refactor_handler.py\\8dd7f3ae0de6cd7987f49d78c1d06ade94435c217ac299ae9b2048471b7029e4.json", "terms": ["name", "node", "ast", "symbols", "int", "await", "getattr", "into", "parse", "ap_src", "end_lineno", "str", "and", "lineno", "list", "none", "not", "text", "the", "tid", "tree", "try", "__class__", "__name__", "_abs_path"], "text_preview": "force: Optional[bool] = None,\n) -> None:\n    \"\"\"Split a Python module into per-symbol modules in out_dir, and convert the source into a shim importing moved symbols.\n\n    Strategy: list top-level defs/classes, move each via the same plan as handle_refactor", "line_start": 313, "line_end": 334}, {"sha": "d0022daa78a504b31c4cc30a13986c3b969e9250bf00c7ba6e128f3e3c35fb01", "index": 12, "path": "50555d16__jinx__micro__runtime__handlers__refactor_handler.py\\d0022daa78a504b31c4cc30a13986c3b969e9250bf00c7ba6e128f3e3c35fb01.json", "terms": ["for", "lines", "symbols", "ap_out", "len", "mask", "name", "not", "create_init", "insert_shim", "_truthy", "dst_file", "dst_module", "shim_imports", "else", "false", "list", "max", "min", "none", "src", "str", "true", "_abs_path", "_module_name_from_path"], "text_preview": "await report_result(tid, False, error=\"no top-level symbols to split\")\n            return\n        ci = create_init if create_init is not None else _truthy(\"JINX_REFACTOR_CREATE_INIT\", \"1\")\n        sh = insert_shim if insert_shim is not None else _truthy(\"J", "line_start": 335, "line_end": 357}, {"sha": "7428583f7956e01ec8a7a88b2313c1a833bf09de5ff845a4eb52f0856fbbfed3", "index": 13, "path": "50555d16__jinx__micro__runtime__handlers__refactor_handler.py\\7428583f7956e01ec8a7a88b2313c1a833bf09de5ff845a4eb52f0856fbbfed3.json", "terms": ["kept", "dst_new", "pkg_init_text", "join", "dst_text", "idx", "lines", "__init__", "_read", "ap_out", "dst_file", "pkg_init_path", "and", "await", "code", "endswith", "except", "exception", "len", "max", "min", "name", "not", "path", "try"], "text_preview": "# Insert shim imports into kept at insertion index\n            idx = _import_insertion_index(\"\\n\".join(kept))\n            kept = kept[:idx] + shim_imports + kept[idx:]\n        src_new = (\"\\n\".join(kept)).rstrip(\"\\n\") + \"\\n\"\n        # Build per-symbol desti", "line_start": 358, "line_end": 384}, {"sha": "40e0c535b581bb65446f4fd8c9f04f7b194556dc91b293c98488f0f6158968a9", "index": 14, "path": "50555d16__jinx__micro__runtime__handlers__refactor_handler.py\\40e0c535b581bb65446f4fd8c9f04f7b194556dc91b293c98488f0f6158968a9.json", "terms": ["refactor", "split", "ops_all", "append", "code", "write", "dst_new", "export_line", "init_lines", "name", "await", "meta", "path", "role", "tid", "type", "verify_cb", "init_new", "exports", "force", "not", "rstrip", "_h_batch", "_truthy", "ap_src"], "text_preview": "dst_new += \"\\n\"\n            dst_new += (code.rstrip(\"\\n\") + \"\\n\")\n            ops_all.append({\"type\": \"write\", \"path\": dst_file, \"code\": dst_new, \"meta\": {\"refactor\": \"split\", \"role\": \"dst\", \"symbol\": name}})\n            if ci:\n                export_line ", "line_start": 385, "line_end": 401}], "file_terms": ["str", "lines", "import", "symbol", "path", "from", "not", "await", "none", "for", "and", "dst_new", "name", "append", "join", "split", "strip", "list", "else", "return", "kept", "ops", "code", "meta", "old_mod"]}